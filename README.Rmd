---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/"
)
set.seed(0)
```

# Introduction

`DetectImports` is a R package aimed at distinguishing imported cases from locally acquired cases within a geographically limited genomic sample of an infectious disease. The input is a dated phylogeny of local genomes only, as can be build using `BEAST`, `treedater` or `BactDating`. The main output is an estimated probability of importation for each case in the dated phylogeny.

## Dependencies

`DetectImports` depends on [Stan](https://mc-stan.org/) through CmdStan. Although [other options might exist](https://mc-stan.org/docs/cmdstan-guide/cmdstan-installation.html), for instance using Conda, the simplest option is to install CmdStan via the R package [CmdStanR](https://mc-stan.org/cmdstanr/). You can do so with the commands
```{r eval = FALSE}
install.packages("cmdstanr", repos = c("https://mc-stan.org/r-packages/", getOption("repos")))
library(cmdstanr)
install_cmdstan()
```
The last command will download and compile all the missing dependencies.

## Installation

You can install `DetectImports` directly from github with the commands:

```{r gh-installation, eval = FALSE}
library(devtools)
devtools::install_github("xavierdidelot/DetectImports")
```

The package can then be loaded using:
```{r}
library(DetectImports)
```

## Quick examples

### Simulated tree

First we generate a random dated tree with one import, detect imports, and plot the results:

```{r message=F,warning=F,results='hide'}
library(ape)
library(DetectImports)
set.seed(1)
sim_dated_tree=simImports(localPopStart=2020,importDates=c(2020.25),samplingStartDate=2020,samplingEndDate=2021,samplingNumber=500,globalNeg=0.01)
sim_results=detectImports(sim_dated_tree)
plot(sim_results)
```

The plotting function for the results of `DetectImports` has a `type` parameter which by default is set to `"scatter"`. So the last command will produce a scatterplot of the number of coalescent intervals for each sequence as a function of time, with the sequences corresponding to imports coloured in red. By changing the `type` to `"tree"`, one will get a plot of the original tree and, once again, imported sequences coloured in red:

```{r message=F,warning=F,results='hide'}
plot(sim_results,type="tree")
```

However, that is not all; sequences that have been propagating locally but descend from originally imported sequences will also be coloured &mdash; this time, in blue.


### Tree from real data

For this more realistic example, we will start from the dataset `staph` which is included in the package [`BactDating`](https://github.com/xavierdidelot/BactDating) &mdash; please visit the link for installation instructions. We won't assume knowledge of a dated tree as the one generated by the simulation in the previous example, but rather *produce* a dated tree with `BactDating`. In order to do so, we'll need not only the tree for the sequences in `staph`, which is contained in the field `staph$tree`, but also the dates at which the sequences have been sampled. They are contained in the field `staph$dates`:

```{r message=F,warning=F}
library(BactDating)
staph$dates
```

Given tree and dates, we can then generate a dated tree with `BactDating`:

```{r message=F,warning=F,results='hide'}
staph_dated<-bactdate(staph$tree,staph$dates)
staph_results=detectImports(staph_dated$tree)
```

and then plot the results as before:
```{r message=F,warning=F,results='hide'}
plot(staph_results)
plot(staph_results,type="tree")
```

### Advanced examples

For more advanced examples of use, see the [vignettes](https://github.com/xavierdidelot/DetectImports/vignettes).

